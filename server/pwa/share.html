<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#2196F3" />
    <base href="/pwa/">
    <title>Sharing Link...</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
        background: #f5f5f5;
      }
      h1 { color: #2196f3; margin-bottom: 20px; }
      .card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .status { font-size: 16px; margin-bottom: 16px; }
      .status.processing { color: #2196f3; }
      .status.success { color: #4caf50; }
      .status.error { color: #f44336; }
      .url-display {
        background: #f9f9f9;
        padding: 12px;
        border-radius: 4px;
        word-break: break-all;
        margin: 12px 0;
        font-family: monospace;
        font-size: 14px;
      }
      .detail {
        font-size: 14px;
        color: #666;
        margin-top: 12px;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>LinkShare</h1>
    <div class="card">
      <div id="status" class="status processing">Processing shared link...</div>
      <div id="url-container" style="display: none">
        <strong>URL:</strong>
        <div class="url-display" id="url-display"></div>
      </div>
      <div id="detail" class="detail" style="display: none"></div>
    </div>

    <script>
      function extractUrl() {
        const params = new URLSearchParams(window.location.search);
        const urlParam = params.get("url");
        const textParam = params.get("text");
        const titleParam = params.get("title");

        if (urlParam && urlParam.trim()) {
          return { url: urlParam.trim(), title: titleParam };
        }

        if (textParam) {
          const urlMatch = textParam.match(/https?:\/\/[^\s]+/);
          if (urlMatch) return { url: urlMatch[0], title: titleParam };
        }

        if (titleParam) {
          const urlMatch = titleParam.match(/https?:\/\/[^\s]+/);
          if (urlMatch) return { url: urlMatch[0], title: null };
        }

        return null;
      }

      async function postUrl(url, title) {
        const response = await fetch("/share-link", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url, title }),
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`HTTP ${response.status}: ${text}`);
        }
      }

      (async function () {
        const statusEl = document.getElementById("status");
        const urlContainer = document.getElementById("url-container");
        const urlDisplay = document.getElementById("url-display");
        const detailEl = document.getElementById("detail");

        try {
          const extracted = extractUrl();

          if (!extracted) {
            statusEl.textContent = "No URL found in shared content.";
            statusEl.className = "status error";
            return;
          }

          urlContainer.style.display = "block";
          urlDisplay.textContent = extracted.url;

          await postUrl(extracted.url, extracted.title);

          statusEl.textContent = "Shared!";
          statusEl.className = "status success";
        } catch (error) {
          statusEl.textContent = "Failed to share";
          statusEl.className = "status error";
          detailEl.style.display = "block";
          detailEl.textContent = error.message;
        }
      })();
    </script>
  </body>
</html>
