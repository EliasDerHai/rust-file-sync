<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#2196F3" />
    <base href="/pwa/" />
    <title>Sharing Link...</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
        background: #f5f5f5;
      }
      h1 {
        color: #2196f3;
        margin-bottom: 20px;
      }
      .card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .status {
        font-size: 16px;
        margin-bottom: 16px;
      }
      .status.processing {
        color: #2196f3;
      }
      .status.success {
        color: #4caf50;
      }
      .status.error {
        color: #f44336;
      }
      .status.queued {
        color: #ff9800;
      }
      .url-display {
        background: #f9f9f9;
        padding: 12px;
        border-radius: 4px;
        word-break: break-all;
        margin: 12px 0;
        font-family: monospace;
        font-size: 14px;
      }
      .detail {
        font-size: 14px;
        color: #666;
        margin-top: 12px;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>LinkShare</h1>
    <p id="version" style="margin-top: -16px; margin-bottom: 16px; font-size: 12px; color: #999"></p>
    <div class="card">
      <div id="status" class="status processing">Processing shared link...</div>
      <div id="url-container" style="display: none">
        <strong>URL:</strong>
        <div class="url-display" id="url-display"></div>
      </div>
      <div id="detail" class="detail" style="display: none"></div>
    </div>

    <script type="module">
      import { postLink, syncPendingLinks, getPendingCount, getVersion, getCachedVersion } from "./api.js";

      function extractUrl() {
        const params = new URLSearchParams(window.location.search);
        const urlParam = params.get("url");
        const textParam = params.get("text");
        const titleParam = params.get("title");

        if (urlParam && urlParam.trim()) {
          return { url: urlParam.trim(), title: titleParam };
        }

        if (textParam) {
          const urlMatch = textParam.match(/https?:\/\/[^\s]+/);
          if (urlMatch) return { url: urlMatch[0], title: titleParam };
        }

        if (titleParam) {
          const urlMatch = titleParam.match(/https?:\/\/[^\s]+/);
          if (urlMatch) return { url: urlMatch[0], title: null };
        }

        return null;
      }

      const versionEl = document.getElementById("version");
      const cached = getCachedVersion();
      if (cached) versionEl.textContent = "v" + cached;
      getVersion().then((v) => {
        if (v) versionEl.textContent = "v" + v;
      });

      const statusEl = document.getElementById("status");
      const urlContainer = document.getElementById("url-container");
      const urlDisplay = document.getElementById("url-display");
      const detailEl = document.getElementById("detail");

      const extracted = extractUrl();

      if (!extracted) {
        statusEl.textContent = "No URL found in shared content.";
        statusEl.className = "status error";
      } else {
        urlContainer.style.display = "block";
        urlDisplay.textContent = extracted.url;

        // Post the shared link and sync pending links in parallel
        const [result] = await Promise.all([
          postLink(extracted.url, extracted.title),
          syncPendingLinks().then((syncResult) => {
            if (syncResult.synced > 0) {
              detailEl.style.display = "block";
              detailEl.textContent = `Also synced ${syncResult.synced} pending link${syncResult.synced > 1 ? "s" : ""}`;
            }
          }),
        ]);

        if (result.synced) {
          statusEl.textContent = "Shared!";
          statusEl.className = "status success";
        } else {
          statusEl.textContent = "Queued for sync";
          statusEl.className = "status queued";
          const pendingCount = getPendingCount();
          detailEl.style.display = "block";
          detailEl.textContent = `${pendingCount} link${pendingCount > 1 ? "s" : ""} waiting to sync when online`;
        }
      }
    </script>
  </body>
</html>
